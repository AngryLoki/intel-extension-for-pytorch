#!/bin/bash

SCRIPT=$(realpath "$0")
SCRIPTPATH=$(dirname "$SCRIPT")

MODE=""
LIBTORCH_PATH=""
IPEX_VERSION=""

if [ $# == 3 ]; then
    MODE=$1
    LIBTORCH_PATH=$2
    IPEX_VERSION=$3
else
    echo "Usage: bash $0 [install|uninstall] <libtorch_path> <ipex_version>"
    exit
fi

if [[ ! ${MODE} == "install" ]] && [[ ! ${MODE} == "uninstall" ]]; then
    echo "Unrecognized execution mode: ${MODE}"
    exit
fi

if [ ! -f ${LIBTORCH_PATH}/build-version ]; then
    echo "${LIBTORCH_PATH} doesn't seem to be directory of libtorch."
    exit
fi

if [[ ${MODE} == "install" ]]; then
    TORCH_VERSION=$(cat ${LIBTORCH_PATH}/build-version)
    [[ ${TORCH_VERSION} =~ ([0-9]+\.[0-9]+).* ]]
    TORCH_VER=${BASH_REMATCH[1]}
    [[ ${IPEX_VERSION} =~ ([0-9]+\.[0-9]+).* ]]
    IPEX_VER=${BASH_REMATCH[1]}
    if [[ ${IPEX_VER} != ${TORCH_VER} ]]; then
        echo "Installation failed."
        echo "ERROR! IntelÂ® Extension for PyTorch* needs to work with libtorch ${IPEX_VER}.*, but libtorch ${TORCH_VERSION} is found. Please switch to the matching version and run again."
        exit
    fi

    while IFS= read -r lib
    do
        lib_fn=$(basename $lib)
        if [ -f ${LIBTORCH_PATH}/lib/${lib_fn} ]; then
            echo "Installation failed."
            echo "${lib_fn} already exists in ${LIBTORCH_PATH}."
            exit
        fi
    done < <(ls -1 ${SCRIPTPATH}/../lib/*.so)
    cp ${SCRIPTPATH}/../lib/*.so ${LIBTORCH_PATH}/lib
    if [ $? -gt 0 ]; then
        echo "Installation failed."
        echo "Please check if ${LIBTORCH_PATH}/lib exists or if you have privileges to write in ${LIBTORCH_PATH}/lib."
        exit
    fi

    mkdir -p ${LIBTORCH_PATH}/share/cmake/IPEX
    if [ $? -gt 0 ]; then
        echo "Installation failed."
        echo "Please check if ${LIBTORCH_PATH}/share/cmake exists or if you have privileges to write in ${LIBTORCH_PATH}/share/cmake."
        exit
    fi
    cp ${SCRIPTPATH}/../share/cmake/IPEX/IPEXConfig.cmake ${LIBTORCH_PATH}/share/cmake/IPEX
    cp ${SCRIPTPATH}/../share/cmake/IPEX/IPEXVersionConfig.cmake ${LIBTORCH_PATH}/share/cmake/IPEX

    echo $IPEX_VERSION > ${LIBTORCH_PATH}/build-version-ipex
    echo "Installation successed!"
elif [[ ${MODE} == "uninstall" ]]; then
    while IFS= read -r lib
    do
        lib_fn=$(basename $lib)
        if [ -f ${LIBTORCH_PATH}/lib/${lib_fn} ]; then
            rm ${LIBTORCH_PATH}/lib/${lib_fn}
        fi
    done < <(ls -1 ${SCRIPTPATH}/../lib/*.so)
    if [ -d ${LIBTORCH_PATH}/share/cmake/IPEX ]; then
        rm -rf ${LIBTORCH_PATH}/share/cmake/IPEX
    fi
    if [ -f ${LIBTORCH_PATH}/build-version-ipex ]; then
        rm ${LIBTORCH_PATH}/build-version-ipex
    fi
    echo "Uninstallation successed!"
fi
