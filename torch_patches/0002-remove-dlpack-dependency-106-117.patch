From f0a55fc2cc4af937f812c4a1b14bdc077b2988b4 Mon Sep 17 00:00:00 2001
From: "Yu, Guangye" <106960996+guangyey@users.noreply.github.com>
Date: Fri, 21 Apr 2023 11:39:50 +0800
Subject: [PATCH 2/9] remove dlpack dependency (#106) (#117)

* remove dlpack dependency
* rich comments
---
 aten/src/ATen/DLConvertor.cpp            |  2 +-
 aten/src/ATen/detail/XPUHooksInterface.h | 11 ++++++++---
 aten/src/ATen/dlpack.h                   |  5 ++++-
 3 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/aten/src/ATen/DLConvertor.cpp b/aten/src/ATen/DLConvertor.cpp
index 68e5a42069c..84d198eba93 100644
--- a/aten/src/ATen/DLConvertor.cpp
+++ b/aten/src/ATen/DLConvertor.cpp
@@ -92,7 +92,7 @@ DLDevice getDLDevice(const Tensor& tensor, const int64_t& device_id) {
       break;
     case DeviceType::XPU:
       ctx = at::detail::getXPUHooks().getDLPackDeviceFromATenDevice(
-          tensor.device(), tensor.data_ptr());
+          ctx, tensor.device(), tensor.data_ptr());
       break;
     default:
       TORCH_CHECK(false, "Cannot pack tensors on " + tensor.device().str());
diff --git a/aten/src/ATen/detail/XPUHooksInterface.h b/aten/src/ATen/detail/XPUHooksInterface.h
index ff42ca60d4..584ccf8d8c 100644
--- a/aten/src/ATen/detail/XPUHooksInterface.h
+++ b/aten/src/ATen/detail/XPUHooksInterface.h
@@ -1,6 +1,5 @@
 #pragma once
 
-#include <ATen/dlpack.h>
 #include <c10/core/Device.h>
 #include <c10/util/Exception.h>
 
@@ -14,6 +13,11 @@ namespace at {
 class Context;
 }
 
+// We use forward declaration here instead of #include <ATen/dlpack.h> to avoid
+// leaking DLPack implementation detail to every project that includes `ATen/Context.h`, which in turn
+// would lead to a conflict when linked with another project using DLPack (for example TVM)
+struct DLDevice_;
+
 namespace at {
 
 constexpr const char* XPU_HELP =
@@ -45,7 +49,7 @@ struct TORCH_API XPUHooksInterface {
   }
 
   virtual Device getATenDeviceFromDLPackDevice(
-      const DLDevice& dl_device,
+      const DLDevice_& dl_device,
       void* data) const {
     TORCH_CHECK(
         false,
@@ -53,7 +57,8 @@ struct TORCH_API XPUHooksInterface {
         XPU_HELP);
   };
 
-  virtual DLDevice getDLPackDeviceFromATenDevice(
+  virtual DLDevice_& getDLPackDeviceFromATenDevice(
+      DLDevice_& dl_device,
       const Device& aten_device,
       void* data) const {
     TORCH_CHECK(
diff --git a/aten/src/ATen/dlpack.h b/aten/src/ATen/dlpack.h
index 3d33935d31..ef6960b23a 100644
--- a/aten/src/ATen/dlpack.h
+++ b/aten/src/ATen/dlpack.h
@@ -94,7 +94,10 @@ typedef enum {
 /*!
  * \brief A Device for Tensor and operator.
  */
-typedef struct {
+// NB: This is the only difference from
+// https://github.com/dmlc/dlpack/blob/v0.7/include/dlpack/dlpack.h Required to
+// allow forward declaration of DLDevice.
+typedef struct DLDevice_ {
   /*! \brief The device type used in the device. */
   DLDeviceType device_type;
   /*!
-- 
2.25.1

